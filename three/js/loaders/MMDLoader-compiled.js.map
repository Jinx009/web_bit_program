{"version":3,"sources":["MMDLoader.js"],"names":[],"mappings":"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","file":"MMDLoader-compiled.js","sourcesContent":["console.warn( \"THREE.MMDLoader: As part of the transition to ES6 Modules, the files in 'examples/js' were deprecated in May 2020 (r117) and will be deleted in December 2020 (r124). You can find more information about developing using ES6 Modules in https://threejs.org/docs/#manual/en/introduction/Installation.\" );\n/**\n * Dependencies\n *  - mmd-parser https://github.com/takahirox/mmd-parser\n *  - THREE.TGALoader\n *  - THREE.OutlineEffect\n *\n * MMDLoader creates Three.js Objects from MMD resources as\n * PMD, PMX, VMD, and VPD files.\n *\n * PMD/PMX is a model data format, VMD is a motion data format\n * VPD is a posing data format used in MMD(Miku Miku Dance).\n *\n * MMD official site\n *  - https://sites.google.com/view/evpvp/\n *\n * PMD, VMD format (in Japanese)\n *  - http://blog.goo.ne.jp/torisu_tetosuki/e/209ad341d3ece2b1b4df24abf619d6e4\n *\n * PMX format\n *  - https://gist.github.com/felixjones/f8a06bd48f9da9a4539f\n *\n * TODO\n *  - light motion in vmd support.\n *  - SDEF support.\n *  - uv/material/bone morphing support.\n *  - more precise grant skinning support.\n *  - shadow support.\n */\n\nTHREE.MMDLoader = ( function () {\n\n\t/**\n\t * @param {THREE.LoadingManager} manager\n\t */\n\tfunction MMDLoader( manager ) {\n\n\t\tTHREE.Loader.call( this, manager );\n\n\t\tthis.loader = new THREE.FileLoader( this.manager );\n\n\t\tthis.parser = null; // lazy generation\n\t\tthis.meshBuilder = new MeshBuilder( this.manager );\n\t\tthis.animationBuilder = new AnimationBuilder();\n\n\t}\n\n\tMMDLoader.prototype = Object.assign( Object.create( THREE.Loader.prototype ), {\n\n\t\tconstructor: MMDLoader,\n\n\t\t/**\n\t\t * @param {string} animationPath\n\t\t * @return {THREE.MMDLoader}\n\t\t */\n\t\tsetAnimationPath: function ( animationPath ) {\n\n\t\t\tthis.animationPath = animationPath;\n\t\t\treturn this;\n\n\t\t},\n\n\t\t// Load MMD assets as Three.js Object\n\n\t\t/**\n\t\t * Loads Model file (.pmd or .pmx) as a THREE.SkinnedMesh.\n\t\t *\n\t\t * @param {string} url - url to Model(.pmd or .pmx) file\n\t\t * @param {function} onLoad\n\t\t * @param {function} onProgress\n\t\t * @param {function} onError\n\t\t */\n\t\tload: function ( url, onLoad, onProgress, onError ) {\n\n\t\t\tvar builder = this.meshBuilder.setCrossOrigin( this.crossOrigin );\n\n\t\t\t// resource path\n\n\t\t\tvar resourcePath;\n\n\t\t\tif ( this.resourcePath !== '' ) {\n\n\t\t\t\tresourcePath = this.resourcePath;\n\n\t\t\t} else if ( this.path !== '' ) {\n\n\t\t\t\tresourcePath = this.path;\n\n\t\t\t} else {\n\n\t\t\t\tresourcePath = THREE.LoaderUtils.extractUrlBase( url );\n\n\t\t\t}\n\n\t\t\tvar modelExtension = this._extractExtension( url ).toLowerCase();\n\n\t\t\t// Should I detect by seeing header?\n\t\t\tif ( modelExtension !== 'pmd' && modelExtension !== 'pmx' ) {\n\n\t\t\t\tif ( onError ) onError( new Error( 'THREE.MMDLoader: Unknown model file extension .' + modelExtension + '.' ) );\n\n\t\t\t\treturn;\n\n\t\t\t}\n\n\t\t\tthis[ modelExtension === 'pmd' ? 'loadPMD' : 'loadPMX' ]( url, function ( data ) {\n\n\t\t\t\tonLoad(\tbuilder.build( data, resourcePath, onProgress, onError )\t);\n\n\t\t\t}, onProgress, onError );\n\n\t\t},\n\n\t\t/**\n\t\t * Loads Motion file(s) (.vmd) as a THREE.AnimationClip.\n\t\t * If two or more files are specified, they'll be merged.\n\t\t *\n\t\t * @param {string|Array<string>} url - url(s) to animation(.vmd) file(s)\n\t\t * @param {THREE.SkinnedMesh|THREE.Camera} object - tracks will be fitting to this object\n\t\t * @param {function} onLoad\n\t\t * @param {function} onProgress\n\t\t * @param {function} onError\n\t\t */\n\t\tloadAnimation: function ( url, object, onLoad, onProgress, onError ) {\n\n\t\t\tvar builder = this.animationBuilder;\n\n\t\t\tthis.loadVMD( url, function ( vmd ) {\n\n\t\t\t\tonLoad( object.isCamera\n\t\t\t\t\t? builder.buildCameraAnimation( vmd )\n\t\t\t\t\t: builder.build( vmd, object ) );\n\n\t\t\t}, onProgress, onError );\n\n\t\t},\n\n\t\t/**\n\t\t * Loads mode file and motion file(s) as an object containing\n\t\t * a THREE.SkinnedMesh and a THREE.AnimationClip.\n\t\t * Tracks of THREE.AnimationClip are fitting to the model.\n\t\t *\n\t\t * @param {string} modelUrl - url to Model(.pmd or .pmx) file\n\t\t * @param {string|Array{string}} vmdUrl - url(s) to animation(.vmd) file\n\t\t * @param {function} onLoad\n\t\t * @param {function} onProgress\n\t\t * @param {function} onError\n\t\t */\n\t\tloadWithAnimation: function ( modelUrl, vmdUrl, onLoad, onProgress, onError ) {\n\n\t\t\tvar scope = this;\n\n\t\t\tthis.load( modelUrl, function ( mesh ) {\n\n\t\t\t\tscope.loadAnimation( vmdUrl, mesh, function ( animation ) {\n\n\t\t\t\t\tonLoad( {\n\t\t\t\t\t\tmesh: mesh,\n\t\t\t\t\t\tanimation: animation\n\t\t\t\t\t} );\n\n\t\t\t\t}, onProgress, onError );\n\n\t\t\t}, onProgress, onError );\n\n\t\t},\n\n\t\t// Load MMD assets as Object data parsed by MMDParser\n\n\t\t/**\n\t\t * Loads .pmd file as an Object.\n\t\t *\n\t\t * @param {string} url - url to .pmd file\n\t\t * @param {function} onLoad\n\t\t * @param {function} onProgress\n\t\t * @param {function} onError\n\t\t */\n\t\tloadPMD: function ( url, onLoad, onProgress, onError ) {\n\n\t\t\tvar parser = this._getParser();\n\n\t\t\tthis.loader\n\t\t\t\t.setMimeType( undefined )\n\t\t\t\t.setPath( this.path )\n\t\t\t\t.setResponseType( 'arraybuffer' )\n\t\t\t\t.setRequestHeader( this.requestHeader )\n\t\t\t\t.setWithCredentials( this.withCredentials )\n\t\t\t\t.load( url, function ( buffer ) {\n\n\t\t\t\t\tonLoad( parser.parsePmd( buffer, true ) );\n\n\t\t\t\t}, onProgress, onError );\n\n\t\t},\n\n\t\t/**\n\t\t * Loads .pmx file as an Object.\n\t\t *\n\t\t * @param {string} url - url to .pmx file\n\t\t * @param {function} onLoad\n\t\t * @param {function} onProgress\n\t\t * @param {function} onError\n\t\t */\n\t\tloadPMX: function ( url, onLoad, onProgress, onError ) {\n\n\t\t\tvar parser = this._getParser();\n\n\t\t\tthis.loader\n\t\t\t\t.setMimeType( undefined )\n\t\t\t\t.setPath( this.path )\n\t\t\t\t.setResponseType( 'arraybuffer' )\n\t\t\t\t.setRequestHeader( this.requestHeader )\n\t\t\t\t.setWithCredentials( this.withCredentials )\n\t\t\t\t.load( url, function ( buffer ) {\n\n\t\t\t\t\tonLoad( parser.parsePmx( buffer, true ) );\n\n\t\t\t\t}, onProgress, onError );\n\n\t\t},\n\n\t\t/**\n\t\t * Loads .vmd file as an Object. If two or more files are specified\n\t\t * they'll be merged.\n\t\t *\n\t\t * @param {string|Array<string>} url - url(s) to .vmd file(s)\n\t\t * @param {function} onLoad\n\t\t * @param {function} onProgress\n\t\t * @param {function} onError\n\t\t */\n\t\tloadVMD: function ( url, onLoad, onProgress, onError ) {\n\n\t\t\tvar urls = Array.isArray( url ) ? url : [ url ];\n\n\t\t\tvar vmds = [];\n\t\t\tvar vmdNum = urls.length;\n\n\t\t\tvar parser = this._getParser();\n\n\t\t\tthis.loader\n\t\t\t\t.setMimeType( undefined )\n\t\t\t\t.setPath( this.animationPath )\n\t\t\t\t.setResponseType( 'arraybuffer' )\n\t\t\t\t.setRequestHeader( this.requestHeader )\n\t\t\t\t.setWithCredentials( this.withCredentials );\n\n\t\t\tfor ( var i = 0, il = urls.length; i < il; i ++ ) {\n\n\t\t\t\tthis.loader.load( urls[ i ], function ( buffer ) {\n\n\t\t\t\t\tvmds.push( parser.parseVmd( buffer, true ) );\n\n\t\t\t\t\tif ( vmds.length === vmdNum ) onLoad( parser.mergeVmds( vmds ) );\n\n\t\t\t\t}, onProgress, onError );\n\n\t\t\t}\n\n\t\t},\n\n\t\t/**\n\t\t * Loads .vpd file as an Object.\n\t\t *\n\t\t * @param {string} url - url to .vpd file\n\t\t * @param {boolean} isUnicode\n\t\t * @param {function} onLoad\n\t\t * @param {function} onProgress\n\t\t * @param {function} onError\n\t\t */\n\t\tloadVPD: function ( url, isUnicode, onLoad, onProgress, onError ) {\n\n\t\t\tvar parser = this._getParser();\n\n\t\t\tthis.loader\n\t\t\t\t.setMimeType( isUnicode ? undefined : 'text/plain; charset=shift_jis' )\n\t\t\t\t.setPath( this.animationPath )\n\t\t\t\t.setResponseType( 'text' )\n\t\t\t\t.setRequestHeader( this.requestHeader )\n\t\t\t\t.setWithCredentials( this.withCredentials )\n\t\t\t\t.load( url, function ( text ) {\n\n\t\t\t\t\tonLoad( parser.parseVpd( text, true ) );\n\n\t\t\t\t}, onProgress, onError );\n\n\t\t},\n\n\t\t// private methods\n\n\t\t_extractExtension: function ( url ) {\n\n\t\t\tvar index = url.lastIndexOf( '.' );\n\t\t\treturn index < 0 ? '' : url.slice( index + 1 );\n\n\t\t},\n\n\t\t_getParser: function () {\n\n\t\t\tif ( this.parser === null ) {\n\n\t\t\t\tif ( typeof MMDParser === 'undefined' ) {\n\n\t\t\t\t\tthrow new Error( 'THREE.MMDLoader: Import MMDParser https://github.com/takahirox/mmd-parser' );\n\n\t\t\t\t}\n\n\t\t\t\tthis.parser = new MMDParser.Parser(); // eslint-disable-line no-undef\n\n\t\t\t}\n\n\t\t\treturn this.parser;\n\n\t\t}\n\n\t} );\n\n\t// Utilities\n\n\t/*\n\t * base64 encoded defalut toon textures toon00.bmp - toon10.bmp.\n\t * We don't need to request external toon image files.\n\t * This idea is from http://www20.atpages.jp/katwat/three.js_r58/examples/mytest37/mmd.three.js\n\t */\n\tvar DEFAULT_TOON_TEXTURES = [\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==',\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC',\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==',\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==',\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=',\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=',\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=',\n\t\t'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII='\n\t];\n\n\t// Builders. They build Three.js object from Object data parsed by MMDParser.\n\n\t/**\n\t * @param {THREE.LoadingManager} manager\n\t */\n\tfunction MeshBuilder( manager ) {\n\n\t\tthis.geometryBuilder = new GeometryBuilder();\n\t\tthis.materialBuilder = new MaterialBuilder( manager );\n\n\t}\n\n\tMeshBuilder.prototype = {\n\n\t\tconstructor: MeshBuilder,\n\n\t\tcrossOrigin: 'anonymous',\n\n\t\t/**\n\t\t * @param {string} crossOrigin\n\t\t * @return {MeshBuilder}\n\t\t */\n\t\tsetCrossOrigin: function ( crossOrigin ) {\n\n\t\t\tthis.crossOrigin = crossOrigin;\n\t\t\treturn this;\n\n\t\t},\n\n\t\t/**\n\t\t * @param {Object} data - parsed PMD/PMX data\n\t\t * @param {string} resourcePath\n\t\t * @param {function} onProgress\n\t\t * @param {function} onError\n\t\t * @return {THREE.SkinnedMesh}\n\t\t */\n\t\tbuild: function ( data, resourcePath, onProgress, onError ) {\n\n\t\t\tvar geometry = this.geometryBuilder.build( data );\n\t\t\tvar material = this.materialBuilder\n\t\t\t\t.setCrossOrigin( this.crossOrigin )\n\t\t\t\t.setResourcePath( resourcePath )\n\t\t\t\t.build( data, geometry, onProgress, onError );\n\n\t\t\tvar mesh = new THREE.SkinnedMesh( geometry, material );\n\n\t\t\tvar skeleton = new THREE.Skeleton( initBones( mesh ) );\n\t\t\tmesh.bind( skeleton );\n\n\t\t\t// console.log( mesh ); // for console debug\n\n\t\t\treturn mesh;\n\n\t\t}\n\n\t};\n\n\t// TODO: Try to remove this function\n\n\tfunction initBones( mesh ) {\n\n\t\tvar geometry = mesh.geometry;\n\n\t\tvar bones = [], bone, gbone;\n\t\tvar i, il;\n\n\t\tif ( geometry && geometry.bones !== undefined ) {\n\n\t\t\t// first, create array of 'Bone' objects from geometry data\n\n\t\t\tfor ( i = 0, il = geometry.bones.length; i < il; i ++ ) {\n\n\t\t\t\tgbone = geometry.bones[ i ];\n\n\t\t\t\t// create new 'Bone' object\n\n\t\t\t\tbone = new THREE.Bone();\n\t\t\t\tbones.push( bone );\n\n\t\t\t\t// apply values\n\n\t\t\t\tbone.name = gbone.name;\n\t\t\t\tbone.position.fromArray( gbone.pos );\n\t\t\t\tbone.quaternion.fromArray( gbone.rotq );\n\t\t\t\tif ( gbone.scl !== undefined ) bone.scale.fromArray( gbone.scl );\n\n\t\t\t}\n\n\t\t\t// second, create bone hierarchy\n\n\t\t\tfor ( i = 0, il = geometry.bones.length; i < il; i ++ ) {\n\n\t\t\t\tgbone = geometry.bones[ i ];\n\n\t\t\t\tif ( ( gbone.parent !== - 1 ) && ( gbone.parent !== null ) && ( bones[ gbone.parent ] !== undefined ) ) {\n\n\t\t\t\t\t// subsequent bones in the hierarchy\n\n\t\t\t\t\tbones[ gbone.parent ].add( bones[ i ] );\n\n\t\t\t\t} else {\n\n\t\t\t\t\t// topmost bone, immediate child of the skinned mesh\n\n\t\t\t\t\tmesh.add( bones[ i ] );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t}\n\n\t\t// now the bones are part of the scene graph and children of the skinned mesh.\n\t\t// let's update the corresponding matrices\n\n\t\tmesh.updateMatrixWorld( true );\n\n\t\treturn bones;\n\n\t}\n\n\t//\n\n\tfunction GeometryBuilder() {\n\n\t}\n\n\tGeometryBuilder.prototype = {\n\n\t\tconstructor: GeometryBuilder,\n\n\t\t/**\n\t\t * @param {Object} data - parsed PMD/PMX data\n\t\t * @return {THREE.BufferGeometry}\n\t\t */\n\t\tbuild: function ( data ) {\n\n\t\t\t// for geometry\n\t\t\tvar positions = [];\n\t\t\tvar uvs = [];\n\t\t\tvar normals = [];\n\n\t\t\tvar indices = [];\n\n\t\t\tvar groups = [];\n\n\t\t\tvar bones = [];\n\t\t\tvar skinIndices = [];\n\t\t\tvar skinWeights = [];\n\n\t\t\tvar morphTargets = [];\n\t\t\tvar morphPositions = [];\n\n\t\t\tvar iks = [];\n\t\t\tvar grants = [];\n\n\t\t\tvar rigidBodies = [];\n\t\t\tvar constraints = [];\n\n\t\t\t// for work\n\t\t\tvar offset = 0;\n\t\t\tvar boneTypeTable = {};\n\n\t\t\t// positions, normals, uvs, skinIndices, skinWeights\n\n\t\t\tfor ( var i = 0; i < data.metadata.vertexCount; i ++ ) {\n\n\t\t\t\tvar v = data.vertices[ i ];\n\n\t\t\t\tfor ( var j = 0, jl = v.position.length; j < jl; j ++ ) {\n\n\t\t\t\t\tpositions.push( v.position[ j ] );\n\n\t\t\t\t}\n\n\t\t\t\tfor ( var j = 0, jl = v.normal.length; j < jl; j ++ ) {\n\n\t\t\t\t\tnormals.push( v.normal[ j ] );\n\n\t\t\t\t}\n\n\t\t\t\tfor ( var j = 0, jl = v.uv.length; j < jl; j ++ ) {\n\n\t\t\t\t\tuvs.push( v.uv[ j ] );\n\n\t\t\t\t}\n\n\t\t\t\tfor ( var j = 0; j < 4; j ++ ) {\n\n\t\t\t\t\tskinIndices.push( v.skinIndices.length - 1 >= j ? v.skinIndices[ j ] : 0.0 );\n\n\t\t\t\t}\n\n\t\t\t\tfor ( var j = 0; j < 4; j ++ ) {\n\n\t\t\t\t\tskinWeights.push( v.skinWeights.length - 1 >= j ? v.skinWeights[ j ] : 0.0 );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// indices\n\n\t\t\tfor ( var i = 0; i < data.metadata.faceCount; i ++ ) {\n\n\t\t\t\tvar face = data.faces[ i ];\n\n\t\t\t\tfor ( var j = 0, jl = face.indices.length; j < jl; j ++ ) {\n\n\t\t\t\t\tindices.push( face.indices[ j ] );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// groups\n\n\t\t\tfor ( var i = 0; i < data.metadata.materialCount; i ++ ) {\n\n\t\t\t\tvar material = data.materials[ i ];\n\n\t\t\t\tgroups.push( {\n\t\t\t\t\toffset: offset * 3,\n\t\t\t\t\tcount: material.faceCount * 3\n\t\t\t\t} );\n\n\t\t\t\toffset += material.faceCount;\n\n\t\t\t}\n\n\t\t\t// bones\n\n\t\t\tfor ( var i = 0; i < data.metadata.rigidBodyCount; i ++ ) {\n\n\t\t\t\tvar body = data.rigidBodies[ i ];\n\t\t\t\tvar value = boneTypeTable[ body.boneIndex ];\n\n\t\t\t\t// keeps greater number if already value is set without any special reasons\n\t\t\t\tvalue = value === undefined ? body.type : Math.max( body.type, value );\n\n\t\t\t\tboneTypeTable[ body.boneIndex ] = value;\n\n\t\t\t}\n\n\t\t\tfor ( var i = 0; i < data.metadata.boneCount; i ++ ) {\n\n\t\t\t\tvar boneData = data.bones[ i ];\n\n\t\t\t\tvar bone = {\n\t\t\t\t\tparent: boneData.parentIndex,\n\t\t\t\t\tname: boneData.name,\n\t\t\t\t\tpos: boneData.position.slice( 0, 3 ),\n\t\t\t\t\trotq: [ 0, 0, 0, 1 ],\n\t\t\t\t\tscl: [ 1, 1, 1 ],\n\t\t\t\t\trigidBodyType: boneTypeTable[ i ] !== undefined ? boneTypeTable[ i ] : - 1\n\t\t\t\t};\n\n\t\t\t\tif ( bone.parent !== - 1 ) {\n\n\t\t\t\t\tbone.pos[ 0 ] -= data.bones[ bone.parent ].position[ 0 ];\n\t\t\t\t\tbone.pos[ 1 ] -= data.bones[ bone.parent ].position[ 1 ];\n\t\t\t\t\tbone.pos[ 2 ] -= data.bones[ bone.parent ].position[ 2 ];\n\n\t\t\t\t}\n\n\t\t\t\tbones.push( bone );\n\n\t\t\t}\n\n\t\t\t// iks\n\n\t\t\t// TODO: remove duplicated codes between PMD and PMX\n\t\t\tif ( data.metadata.format === 'pmd' ) {\n\n\t\t\t\tfor ( var i = 0; i < data.metadata.ikCount; i ++ ) {\n\n\t\t\t\t\tvar ik = data.iks[ i ];\n\n\t\t\t\t\tvar param = {\n\t\t\t\t\t\ttarget: ik.target,\n\t\t\t\t\t\teffector: ik.effector,\n\t\t\t\t\t\titeration: ik.iteration,\n\t\t\t\t\t\tmaxAngle: ik.maxAngle * 4,\n\t\t\t\t\t\tlinks: []\n\t\t\t\t\t};\n\n\t\t\t\t\tfor ( var j = 0, jl = ik.links.length; j < jl; j ++ ) {\n\n\t\t\t\t\t\tvar link = {};\n\t\t\t\t\t\tlink.index = ik.links[ j ].index;\n\t\t\t\t\t\tlink.enabled = true;\n\n\t\t\t\t\t\tif ( data.bones[ link.index ].name.indexOf( '' ) >= 0 ) {\n\n\t\t\t\t\t\t\tlink.limitation = new THREE.Vector3( 1.0, 0.0, 0.0 );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tparam.links.push( link );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tiks.push( param );\n\n\t\t\t\t}\n\n\t\t\t} else {\n\n\t\t\t\tfor ( var i = 0; i < data.metadata.boneCount; i ++ ) {\n\n\t\t\t\t\tvar ik = data.bones[ i ].ik;\n\n\t\t\t\t\tif ( ik === undefined ) continue;\n\n\t\t\t\t\tvar param = {\n\t\t\t\t\t\ttarget: i,\n\t\t\t\t\t\teffector: ik.effector,\n\t\t\t\t\t\titeration: ik.iteration,\n\t\t\t\t\t\tmaxAngle: ik.maxAngle,\n\t\t\t\t\t\tlinks: []\n\t\t\t\t\t};\n\n\t\t\t\t\tfor ( var j = 0, jl = ik.links.length; j < jl; j ++ ) {\n\n\t\t\t\t\t\tvar link = {};\n\t\t\t\t\t\tlink.index = ik.links[ j ].index;\n\t\t\t\t\t\tlink.enabled = true;\n\n\t\t\t\t\t\tif ( ik.links[ j ].angleLimitation === 1 ) {\n\n\t\t\t\t\t\t\t// Revert if rotationMin/Max doesn't work well\n\t\t\t\t\t\t\t// link.limitation = new THREE.Vector3( 1.0, 0.0, 0.0 );\n\n\t\t\t\t\t\t\tvar rotationMin = ik.links[ j ].lowerLimitationAngle;\n\t\t\t\t\t\t\tvar rotationMax = ik.links[ j ].upperLimitationAngle;\n\n\t\t\t\t\t\t\t// Convert Left to Right coordinate by myself because\n\t\t\t\t\t\t\t// MMDParser doesn't convert. It's a MMDParser's bug\n\n\t\t\t\t\t\t\tvar tmp1 = - rotationMax[ 0 ];\n\t\t\t\t\t\t\tvar tmp2 = - rotationMax[ 1 ];\n\t\t\t\t\t\t\trotationMax[ 0 ] = - rotationMin[ 0 ];\n\t\t\t\t\t\t\trotationMax[ 1 ] = - rotationMin[ 1 ];\n\t\t\t\t\t\t\trotationMin[ 0 ] = tmp1;\n\t\t\t\t\t\t\trotationMin[ 1 ] = tmp2;\n\n\t\t\t\t\t\t\tlink.rotationMin = new THREE.Vector3().fromArray( rotationMin );\n\t\t\t\t\t\t\tlink.rotationMax = new THREE.Vector3().fromArray( rotationMax );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tparam.links.push( link );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tiks.push( param );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// grants\n\n\t\t\tif ( data.metadata.format === 'pmx' ) {\n\n\t\t\t\tfor ( var i = 0; i < data.metadata.boneCount; i ++ ) {\n\n\t\t\t\t\tvar boneData = data.bones[ i ];\n\t\t\t\t\tvar grant = boneData.grant;\n\n\t\t\t\t\tif ( grant === undefined ) continue;\n\n\t\t\t\t\tvar param = {\n\t\t\t\t\t\tindex: i,\n\t\t\t\t\t\tparentIndex: grant.parentIndex,\n\t\t\t\t\t\tratio: grant.ratio,\n\t\t\t\t\t\tisLocal: grant.isLocal,\n\t\t\t\t\t\taffectRotation: grant.affectRotation,\n\t\t\t\t\t\taffectPosition: grant.affectPosition,\n\t\t\t\t\t\ttransformationClass: boneData.transformationClass\n\t\t\t\t\t};\n\n\t\t\t\t\tgrants.push( param );\n\n\t\t\t\t}\n\n\t\t\t\tgrants.sort( function ( a, b ) {\n\n\t\t\t\t\treturn a.transformationClass - b.transformationClass;\n\n\t\t\t\t} );\n\n\t\t\t}\n\n\t\t\t// morph\n\n\t\t\tfunction updateAttributes( attribute, morph, ratio ) {\n\n\t\t\t\tfor ( var i = 0; i < morph.elementCount; i ++ ) {\n\n\t\t\t\t\tvar element = morph.elements[ i ];\n\n\t\t\t\t\tvar index;\n\n\t\t\t\t\tif ( data.metadata.format === 'pmd' ) {\n\n\t\t\t\t\t\tindex = data.morphs[ 0 ].elements[ element.index ].index;\n\n\t\t\t\t\t} else {\n\n\t\t\t\t\t\tindex = element.index;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tattribute.array[ index * 3 + 0 ] += element.position[ 0 ] * ratio;\n\t\t\t\t\tattribute.array[ index * 3 + 1 ] += element.position[ 1 ] * ratio;\n\t\t\t\t\tattribute.array[ index * 3 + 2 ] += element.position[ 2 ] * ratio;\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\tfor ( var i = 0; i < data.metadata.morphCount; i ++ ) {\n\n\t\t\t\tvar morph = data.morphs[ i ];\n\t\t\t\tvar params = { name: morph.name };\n\n\t\t\t\tvar attribute = new THREE.Float32BufferAttribute( data.metadata.vertexCount * 3, 3 );\n\t\t\t\tattribute.name = morph.name;\n\n\t\t\t\tfor ( var j = 0; j < data.metadata.vertexCount * 3; j ++ ) {\n\n\t\t\t\t\tattribute.array[ j ] = positions[ j ];\n\n\t\t\t\t}\n\n\t\t\t\tif ( data.metadata.format === 'pmd' ) {\n\n\t\t\t\t\tif ( i !== 0 ) {\n\n\t\t\t\t\t\tupdateAttributes( attribute, morph, 1.0 );\n\n\t\t\t\t\t}\n\n\t\t\t\t} else {\n\n\t\t\t\t\tif ( morph.type === 0 ) { // group\n\n\t\t\t\t\t\tfor ( var j = 0; j < morph.elementCount; j ++ ) {\n\n\t\t\t\t\t\t\tvar morph2 = data.morphs[ morph.elements[ j ].index ];\n\t\t\t\t\t\t\tvar ratio = morph.elements[ j ].ratio;\n\n\t\t\t\t\t\t\tif ( morph2.type === 1 ) {\n\n\t\t\t\t\t\t\t\tupdateAttributes( attribute, morph2, ratio );\n\n\t\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\t\t// TODO: implement\n\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t} else if ( morph.type === 1 ) { // vertex\n\n\t\t\t\t\t\tupdateAttributes( attribute, morph, 1.0 );\n\n\t\t\t\t\t} else if ( morph.type === 2 ) { // bone\n\n\t\t\t\t\t\t// TODO: implement\n\n\t\t\t\t\t} else if ( morph.type === 3 ) { // uv\n\n\t\t\t\t\t\t// TODO: implement\n\n\t\t\t\t\t} else if ( morph.type === 4 ) { // additional uv1\n\n\t\t\t\t\t\t// TODO: implement\n\n\t\t\t\t\t} else if ( morph.type === 5 ) { // additional uv2\n\n\t\t\t\t\t\t// TODO: implement\n\n\t\t\t\t\t} else if ( morph.type === 6 ) { // additional uv3\n\n\t\t\t\t\t\t// TODO: implement\n\n\t\t\t\t\t} else if ( morph.type === 7 ) { // additional uv4\n\n\t\t\t\t\t\t// TODO: implement\n\n\t\t\t\t\t} else if ( morph.type === 8 ) { // material\n\n\t\t\t\t\t\t// TODO: implement\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tmorphTargets.push( params );\n\t\t\t\tmorphPositions.push( attribute );\n\n\t\t\t}\n\n\t\t\t// rigid bodies from rigidBodies field.\n\n\t\t\tfor ( var i = 0; i < data.metadata.rigidBodyCount; i ++ ) {\n\n\t\t\t\tvar rigidBody = data.rigidBodies[ i ];\n\t\t\t\tvar params = {};\n\n\t\t\t\tfor ( var key in rigidBody ) {\n\n\t\t\t\t\tparams[ key ] = rigidBody[ key ];\n\n\t\t\t\t}\n\n\t\t\t\t/*\n\t\t\t\t * RigidBody position parameter in PMX seems global position\n\t\t\t\t * while the one in PMD seems offset from corresponding bone.\n\t\t\t\t * So unify being offset.\n\t\t\t\t */\n\t\t\t\tif ( data.metadata.format === 'pmx' ) {\n\n\t\t\t\t\tif ( params.boneIndex !== - 1 ) {\n\n\t\t\t\t\t\tvar bone = data.bones[ params.boneIndex ];\n\t\t\t\t\t\tparams.position[ 0 ] -= bone.position[ 0 ];\n\t\t\t\t\t\tparams.position[ 1 ] -= bone.position[ 1 ];\n\t\t\t\t\t\tparams.position[ 2 ] -= bone.position[ 2 ];\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\trigidBodies.push( params );\n\n\t\t\t}\n\n\t\t\t// constraints from constraints field.\n\n\t\t\tfor ( var i = 0; i < data.metadata.constraintCount; i ++ ) {\n\n\t\t\t\tvar constraint = data.constraints[ i ];\n\t\t\t\tvar params = {};\n\n\t\t\t\tfor ( var key in constraint ) {\n\n\t\t\t\t\tparams[ key ] = constraint[ key ];\n\n\t\t\t\t}\n\n\t\t\t\tvar bodyA = rigidBodies[ params.rigidBodyIndex1 ];\n\t\t\t\tvar bodyB = rigidBodies[ params.rigidBodyIndex2 ];\n\n\t\t\t\t// Refer to http://www20.atpages.jp/katwat/wp/?p=4135\n\t\t\t\tif ( bodyA.type !== 0 && bodyB.type === 2 ) {\n\n\t\t\t\t\tif ( bodyA.boneIndex !== - 1 && bodyB.boneIndex !== - 1 &&\n\t\t\t\t\t     data.bones[ bodyB.boneIndex ].parentIndex === bodyA.boneIndex ) {\n\n\t\t\t\t\t\tbodyB.type = 1;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tconstraints.push( params );\n\n\t\t\t}\n\n\t\t\t// build BufferGeometry.\n\n\t\t\tvar geometry = new THREE.BufferGeometry();\n\n\t\t\tgeometry.setAttribute( 'position', new THREE.Float32BufferAttribute( positions, 3 ) );\n\t\t\tgeometry.setAttribute( 'normal', new THREE.Float32BufferAttribute( normals, 3 ) );\n\t\t\tgeometry.setAttribute( 'uv', new THREE.Float32BufferAttribute( uvs, 2 ) );\n\t\t\tgeometry.setAttribute( 'skinIndex', new THREE.Uint16BufferAttribute( skinIndices, 4 ) );\n\t\t\tgeometry.setAttribute( 'skinWeight', new THREE.Float32BufferAttribute( skinWeights, 4 ) );\n\t\t\tgeometry.setIndex( indices );\n\n\t\t\tfor ( var i = 0, il = groups.length; i < il; i ++ ) {\n\n\t\t\t\tgeometry.addGroup( groups[ i ].offset, groups[ i ].count, i );\n\n\t\t\t}\n\n\t\t\tgeometry.bones = bones;\n\n\t\t\tgeometry.morphTargets = morphTargets;\n\t\t\tgeometry.morphAttributes.position = morphPositions;\n\t\t\tgeometry.morphTargetsRelative = false;\n\n\t\t\tgeometry.userData.MMD = {\n\t\t\t\tbones: bones,\n\t\t\t\tiks: iks,\n\t\t\t\tgrants: grants,\n\t\t\t\trigidBodies: rigidBodies,\n\t\t\t\tconstraints: constraints,\n\t\t\t\tformat: data.metadata.format\n\t\t\t};\n\n\t\t\tgeometry.computeBoundingSphere();\n\n\t\t\treturn geometry;\n\n\t\t}\n\n\t};\n\n\t//\n\n\t/**\n\t * @param {THREE.LoadingManager} manager\n\t */\n\tfunction MaterialBuilder( manager ) {\n\n\t\tthis.manager = manager;\n\n\t\tthis.textureLoader = new THREE.TextureLoader( this.manager );\n\t\tthis.tgaLoader = null; // lazy generation\n\n\t}\n\n\tMaterialBuilder.prototype = {\n\n\t\tconstructor: MaterialBuilder,\n\n\t\tcrossOrigin: 'anonymous',\n\n\t\tresourcePath: undefined,\n\n\t\t/**\n\t\t * @param {string} crossOrigin\n\t\t * @return {MaterialBuilder}\n\t\t */\n\t\tsetCrossOrigin: function ( crossOrigin ) {\n\n\t\t\tthis.crossOrigin = crossOrigin;\n\t\t\treturn this;\n\n\t\t},\n\n\t\t/**\n\t\t * @param {string} resourcePath\n\t\t * @return {MaterialBuilder}\n\t\t */\n\t\tsetResourcePath: function ( resourcePath ) {\n\n\t\t\tthis.resourcePath = resourcePath;\n\t\t\treturn this;\n\n\t\t},\n\n\t\t/**\n\t\t * @param {Object} data - parsed PMD/PMX data\n\t\t * @param {THREE.BufferGeometry} geometry - some properties are dependend on geometry\n\t\t * @param {function} onProgress\n\t\t * @param {function} onError\n\t\t * @return {Array<THREE.MeshToonMaterial>}\n\t\t */\n\t\tbuild: function ( data, geometry /*, onProgress, onError */ ) {\n\n\t\t\tvar materials = [];\n\n\t\t\tvar textures = {};\n\n\t\t\tthis.textureLoader.setCrossOrigin( this.crossOrigin );\n\n\t\t\t// materials\n\n\t\t\tfor ( var i = 0; i < data.metadata.materialCount; i ++ ) {\n\n\t\t\t\tvar material = data.materials[ i ];\n\n\t\t\t\tvar params = { userData: {} };\n\n\t\t\t\tif ( material.name !== undefined ) params.name = material.name;\n\n\t\t\t\t/*\n\t\t\t\t * Color\n\t\t\t\t *\n\t\t\t\t * MMD         MeshToonMaterial\n\t\t\t\t * diffuse  -  color\n\t\t\t\t * ambient  -  emissive * a\n\t\t\t\t *               (a = 1.0 without map texture or 0.2 with map texture)\n\t\t\t\t *\n\t\t\t\t * MeshToonMaterial doesn't have ambient. Set it to emissive instead.\n\t\t\t\t * It'll be too bright if material has map texture so using coef 0.2.\n\t\t\t\t */\n\t\t\t\tparams.color = new THREE.Color().fromArray( material.diffuse );\n\t\t\t\tparams.opacity = material.diffuse[ 3 ];\n\t\t\t\tparams.emissive = new THREE.Color().fromArray( material.ambient );\n\t\t\t\tparams.transparent = params.opacity !== 1.0;\n\n\t\t\t\t//\n\n\t\t\t\tparams.skinning = geometry.bones.length > 0 ? true : false;\n\t\t\t\tparams.morphTargets = geometry.morphTargets.length > 0 ? true : false;\n\t\t\t\tparams.fog = true;\n\n\t\t\t\t// blend\n\n\t\t\t\tparams.blending = THREE.CustomBlending;\n\t\t\t\tparams.blendSrc = THREE.SrcAlphaFactor;\n\t\t\t\tparams.blendDst = THREE.OneMinusSrcAlphaFactor;\n\t\t\t\tparams.blendSrcAlpha = THREE.SrcAlphaFactor;\n\t\t\t\tparams.blendDstAlpha = THREE.DstAlphaFactor;\n\n\t\t\t\t// side\n\n\t\t\t\tif ( data.metadata.format === 'pmx' && ( material.flag & 0x1 ) === 1 ) {\n\n\t\t\t\t\tparams.side = THREE.DoubleSide;\n\n\t\t\t\t} else {\n\n\t\t\t\t\tparams.side = params.opacity === 1.0 ? THREE.FrontSide : THREE.DoubleSide;\n\n\t\t\t\t}\n\n\t\t\t\tif ( data.metadata.format === 'pmd' ) {\n\n\t\t\t\t\t// map, envMap\n\n\t\t\t\t\tif ( material.fileName ) {\n\n\t\t\t\t\t\tvar fileName = material.fileName;\n\t\t\t\t\t\tvar fileNames = fileName.split( '*' );\n\n\t\t\t\t\t\t// fileNames[ 0 ]: mapFileName\n\t\t\t\t\t\t// fileNames[ 1 ]: envMapFileName( optional )\n\n\t\t\t\t\t\tparams.map = this._loadTexture( fileNames[ 0 ], textures );\n\n\t\t\t\t\t\tif ( fileNames.length > 1 ) {\n\n\t\t\t\t\t\t\tvar extension = fileNames[ 1 ].slice( - 4 ).toLowerCase();\n\n\t\t\t\t\t\t\tparams.envMap = this._loadTexture(\n\t\t\t\t\t\t\t\tfileNames[ 1 ],\n\t\t\t\t\t\t\t\ttextures\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\tparams.combine = extension === '.sph'\n\t\t\t\t\t\t\t\t? THREE.MultiplyOperation\n\t\t\t\t\t\t\t\t: THREE.AddOperation;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// gradientMap\n\n\t\t\t\t\tvar toonFileName = ( material.toonIndex === - 1 )\n\t\t\t\t\t\t? 'toon00.bmp'\n\t\t\t\t\t\t: data.toonTextures[ material.toonIndex ].fileName;\n\n\t\t\t\t\tparams.gradientMap = this._loadTexture(\n\t\t\t\t\t\ttoonFileName,\n\t\t\t\t\t\ttextures,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tisToonTexture: true,\n\t\t\t\t\t\t\tisDefaultToonTexture: this._isDefaultToonTexture( toonFileName )\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\n\t\t\t\t\t// parameters for OutlineEffect\n\n\t\t\t\t\tparams.userData.outlineParameters = {\n\t\t\t\t\t\tthickness: material.edgeFlag === 1 ? 0.003 : 0.0,\n\t\t\t\t\t\tcolor: [ 0, 0, 0 ],\n\t\t\t\t\t\talpha: 1.0,\n\t\t\t\t\t\tvisible: material.edgeFlag === 1\n\t\t\t\t\t};\n\n\t\t\t\t} else {\n\n\t\t\t\t\t// map\n\n\t\t\t\t\tif ( material.textureIndex !== - 1 ) {\n\n\t\t\t\t\t\tparams.map = this._loadTexture( data.textures[ material.textureIndex ], textures );\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// envMap TODO: support m.envFlag === 3\n\n\t\t\t\t\tif ( material.envTextureIndex !== - 1 && ( material.envFlag === 1 || material.envFlag == 2 ) ) {\n\n\t\t\t\t\t\tparams.envMap = this._loadTexture(\n\t\t\t\t\t\t\tdata.textures[ material.envTextureIndex ],\n\t\t\t\t\t\t\ttextures\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tparams.combine = material.envFlag === 1\n\t\t\t\t\t\t\t? THREE.MultiplyOperation\n\t\t\t\t\t\t\t: THREE.AddOperation;\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// gradientMap\n\n\t\t\t\t\tvar toonFileName, isDefaultToon;\n\n\t\t\t\t\tif ( material.toonIndex === - 1 || material.toonFlag !== 0 ) {\n\n\t\t\t\t\t\ttoonFileName = 'toon' + ( '0' + ( material.toonIndex + 1 ) ).slice( - 2 ) + '.bmp';\n\t\t\t\t\t\tisDefaultToon = true;\n\n\t\t\t\t\t} else {\n\n\t\t\t\t\t\ttoonFileName = data.textures[ material.toonIndex ];\n\t\t\t\t\t\tisDefaultToon = false;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tparams.gradientMap = this._loadTexture(\n\t\t\t\t\t\ttoonFileName,\n\t\t\t\t\t\ttextures,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tisToonTexture: true,\n\t\t\t\t\t\t\tisDefaultToonTexture: isDefaultToon\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\n\t\t\t\t\t// parameters for OutlineEffect\n\t\t\t\t\tparams.userData.outlineParameters = {\n\t\t\t\t\t\tthickness: material.edgeSize / 300, // TODO: better calculation?\n\t\t\t\t\t\tcolor: material.edgeColor.slice( 0, 3 ),\n\t\t\t\t\t\talpha: material.edgeColor[ 3 ],\n\t\t\t\t\t\tvisible: ( material.flag & 0x10 ) !== 0 && material.edgeSize > 0.0\n\t\t\t\t\t};\n\n\t\t\t\t}\n\n\t\t\t\tif ( params.map !== undefined ) {\n\n\t\t\t\t\tif ( ! params.transparent ) {\n\n\t\t\t\t\t\tthis._checkImageTransparency( params.map, geometry, i );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tparams.emissive.multiplyScalar( 0.2 );\n\n\t\t\t\t}\n\n\t\t\t\tmaterials.push( new THREE.MeshToonMaterial( params ) );\n\n\t\t\t}\n\n\t\t\tif ( data.metadata.format === 'pmx' ) {\n\n\t\t\t\t// set transparent true if alpha morph is defined.\n\n\t\t\t\tfunction checkAlphaMorph( elements, materials ) {\n\n\t\t\t\t\tfor ( var i = 0, il = elements.length; i < il; i ++ ) {\n\n\t\t\t\t\t\tvar element = elements[ i ];\n\n\t\t\t\t\t\tif ( element.index === - 1 ) continue;\n\n\t\t\t\t\t\tvar material = materials[ element.index ];\n\n\t\t\t\t\t\tif ( material.opacity !== element.diffuse[ 3 ] ) {\n\n\t\t\t\t\t\t\tmaterial.transparent = true;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tfor ( var i = 0, il = data.morphs.length; i < il; i ++ ) {\n\n\t\t\t\t\tvar morph = data.morphs[ i ];\n\t\t\t\t\tvar elements = morph.elements;\n\n\t\t\t\t\tif ( morph.type === 0 ) {\n\n\t\t\t\t\t\tfor ( var j = 0, jl = elements.length; j < jl; j ++ ) {\n\n\t\t\t\t\t\t\tvar morph2 = data.morphs[ elements[ j ].index ];\n\n\t\t\t\t\t\t\tif ( morph2.type !== 8 ) continue;\n\n\t\t\t\t\t\t\tcheckAlphaMorph( morph2.elements, materials );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t} else if ( morph.type === 8 ) {\n\n\t\t\t\t\t\tcheckAlphaMorph( elements, materials );\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn materials;\n\n\t\t},\n\n\t\t// private methods\n\n\t\t_getTGALoader: function () {\n\n\t\t\tif ( this.tgaLoader === null ) {\n\n\t\t\t\tif ( THREE.TGALoader === undefined ) {\n\n\t\t\t\t\tthrow new Error( 'THREE.MMDLoader: Import THREE.TGALoader' );\n\n\t\t\t\t}\n\n\t\t\t\tthis.tgaLoader = new THREE.TGALoader( this.manager );\n\n\t\t\t}\n\n\t\t\treturn this.tgaLoader;\n\n\t\t},\n\n\t\t_isDefaultToonTexture: function ( name ) {\n\n\t\t\tif ( name.length !== 10 ) return false;\n\n\t\t\treturn /toon(10|0[0-9])\\.bmp/.test( name );\n\n\t\t},\n\n\t\t_loadTexture: function ( filePath, textures, params, onProgress, onError ) {\n\n\t\t\tparams = params || {};\n\n\t\t\tvar scope = this;\n\n\t\t\tvar fullPath;\n\n\t\t\tif ( params.isDefaultToonTexture === true ) {\n\n\t\t\t\tvar index;\n\n\t\t\t\ttry {\n\n\t\t\t\t\tindex = parseInt( filePath.match( /toon([0-9]{2})\\.bmp$/ )[ 1 ] );\n\n\t\t\t\t} catch ( e ) {\n\n\t\t\t\t\tconsole.warn( 'THREE.MMDLoader: ' + filePath + ' seems like a '\n\t\t\t\t\t\t+ 'not right default texture path. Using toon00.bmp instead.' );\n\n\t\t\t\t\tindex = 0;\n\n\t\t\t\t}\n\n\t\t\t\tfullPath = DEFAULT_TOON_TEXTURES[ index ];\n\n\t\t\t} else {\n\n\t\t\t\tfullPath = this.resourcePath + filePath;\n\n\t\t\t}\n\n\t\t\tif ( textures[ fullPath ] !== undefined ) return textures[ fullPath ];\n\n\t\t\tvar loader = this.manager.getHandler( fullPath );\n\n\t\t\tif ( loader === null ) {\n\n\t\t\t\tloader = ( filePath.slice( - 4 ).toLowerCase() === '.tga' )\n\t\t\t\t\t? this._getTGALoader()\n\t\t\t\t\t: this.textureLoader;\n\n\t\t\t}\n\n\t\t\tvar texture = loader.load( fullPath, function ( t ) {\n\n\t\t\t\t// MMD toon texture is Axis-Y oriented\n\t\t\t\t// but Three.js gradient map is Axis-X oriented.\n\t\t\t\t// So here replaces the toon texture image with the rotated one.\n\t\t\t\tif ( params.isToonTexture === true ) {\n\n\t\t\t\t\tt.image = scope._getRotatedImage( t.image );\n\n\t\t\t\t\tt.magFilter = THREE.NearestFilter;\n\t\t\t\t\tt.minFilter = THREE.NearestFilter;\n\n\t\t\t\t}\n\n\t\t\t\tt.flipY = false;\n\t\t\t\tt.wrapS = THREE.RepeatWrapping;\n\t\t\t\tt.wrapT = THREE.RepeatWrapping;\n\n\t\t\t\tfor ( var i = 0; i < texture.readyCallbacks.length; i ++ ) {\n\n\t\t\t\t\ttexture.readyCallbacks[ i ]( texture );\n\n\t\t\t\t}\n\n\t\t\t\tdelete texture.readyCallbacks;\n\n\t\t\t}, onProgress, onError );\n\n\t\t\ttexture.readyCallbacks = [];\n\n\t\t\ttextures[ fullPath ] = texture;\n\n\t\t\treturn texture;\n\n\t\t},\n\n\t\t_getRotatedImage: function ( image ) {\n\n\t\t\tvar canvas = document.createElement( 'canvas' );\n\t\t\tvar context = canvas.getContext( '2d' );\n\n\t\t\tvar width = image.width;\n\t\t\tvar height = image.height;\n\n\t\t\tcanvas.width = width;\n\t\t\tcanvas.height = height;\n\n\t\t\tcontext.clearRect( 0, 0, width, height );\n\t\t\tcontext.translate( width / 2.0, height / 2.0 );\n\t\t\tcontext.rotate( 0.5 * Math.PI ); // 90.0 * Math.PI / 180.0\n\t\t\tcontext.translate( - width / 2.0, - height / 2.0 );\n\t\t\tcontext.drawImage( image, 0, 0 );\n\n\t\t\treturn context.getImageData( 0, 0, width, height );\n\n\t\t},\n\n\t\t// Check if the partial image area used by the texture is transparent.\n\t\t_checkImageTransparency: function ( map, geometry, groupIndex ) {\n\n\t\t\tmap.readyCallbacks.push( function ( texture ) {\n\n\t\t\t\t// Is there any efficient ways?\n\t\t\t\tfunction createImageData( image ) {\n\n\t\t\t\t\tvar canvas = document.createElement( 'canvas' );\n\t\t\t\t\tcanvas.width = image.width;\n\t\t\t\t\tcanvas.height = image.height;\n\n\t\t\t\t\tvar context = canvas.getContext( '2d' );\n\t\t\t\t\tcontext.drawImage( image, 0, 0 );\n\n\t\t\t\t\treturn context.getImageData( 0, 0, canvas.width, canvas.height );\n\n\t\t\t\t}\n\n\t\t\t\tfunction detectImageTransparency( image, uvs, indices ) {\n\n\t\t\t\t\tvar width = image.width;\n\t\t\t\t\tvar height = image.height;\n\t\t\t\t\tvar data = image.data;\n\t\t\t\t\tvar threshold = 253;\n\n\t\t\t\t\tif ( data.length / ( width * height ) !== 4 ) return false;\n\n\t\t\t\t\tfor ( var i = 0; i < indices.length; i += 3 ) {\n\n\t\t\t\t\t\tvar centerUV = { x: 0.0, y: 0.0 };\n\n\t\t\t\t\t\tfor ( var j = 0; j < 3; j ++ ) {\n\n\t\t\t\t\t\t\tvar index = indices[ i * 3 + j ];\n\t\t\t\t\t\t\tvar uv = { x: uvs[ index * 2 + 0 ], y: uvs[ index * 2 + 1 ] };\n\n\t\t\t\t\t\t\tif ( getAlphaByUv( image, uv ) < threshold ) return true;\n\n\t\t\t\t\t\t\tcenterUV.x += uv.x;\n\t\t\t\t\t\t\tcenterUV.y += uv.y;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tcenterUV.x /= 3;\n\t\t\t\t\t\tcenterUV.y /= 3;\n\n\t\t\t\t\t\tif ( getAlphaByUv( image, centerUV ) < threshold ) return true;\n\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\n\t\t\t\t}\n\n\t\t\t\t/*\n\t\t\t\t * This method expects\n\t\t\t\t *   texture.flipY = false\n\t\t\t\t *   texture.wrapS = THREE.RepeatWrapping\n\t\t\t\t *   texture.wrapT = THREE.RepeatWrapping\n\t\t\t\t * TODO: more precise\n\t\t\t\t */\n\t\t\t\tfunction getAlphaByUv( image, uv ) {\n\n\t\t\t\t\tvar width = image.width;\n\t\t\t\t\tvar height = image.height;\n\n\t\t\t\t\tvar x = Math.round( uv.x * width ) % width;\n\t\t\t\t\tvar y = Math.round( uv.y * height ) % height;\n\n\t\t\t\t\tif ( x < 0 ) x += width;\n\t\t\t\t\tif ( y < 0 ) y += height;\n\n\t\t\t\t\tvar index = y * width + x;\n\n\t\t\t\t\treturn image.data[ index * 4 + 3 ];\n\n\t\t\t\t}\n\n\t\t\t\tvar imageData = texture.image.data !== undefined\n\t\t\t\t\t? texture.image\n\t\t\t\t\t: createImageData( texture.image );\n\n\t\t\t\tvar group = geometry.groups[ groupIndex ];\n\n\t\t\t\tif ( detectImageTransparency(\n\t\t\t\t\timageData,\n\t\t\t\t\tgeometry.attributes.uv.array,\n\t\t\t\t\tgeometry.index.array.slice( group.start, group.start + group.count ) ) ) {\n\n\t\t\t\t\tmap.transparent = true;\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t}\n\n\t};\n\n\t//\n\n\tfunction AnimationBuilder() {\n\n\t}\n\n\tAnimationBuilder.prototype = {\n\n\t\tconstructor: AnimationBuilder,\n\n\t\t/**\n\t\t * @param {Object} vmd - parsed VMD data\n\t\t * @param {THREE.SkinnedMesh} mesh - tracks will be fitting to mesh\n\t\t * @return {THREE.AnimationClip}\n\t\t */\n\t\tbuild: function ( vmd, mesh ) {\n\n\t\t\t// combine skeletal and morph animations\n\n\t\t\tvar tracks = this.buildSkeletalAnimation( vmd, mesh ).tracks;\n\t\t\tvar tracks2 = this.buildMorphAnimation( vmd, mesh ).tracks;\n\n\t\t\tfor ( var i = 0, il = tracks2.length; i < il; i ++ ) {\n\n\t\t\t\ttracks.push( tracks2[ i ] );\n\n\t\t\t}\n\n\t\t\treturn new THREE.AnimationClip( '', - 1, tracks );\n\n\t\t},\n\n\t\t/**\n\t\t * @param {Object} vmd - parsed VMD data\n\t\t * @param {THREE.SkinnedMesh} mesh - tracks will be fitting to mesh\n\t\t * @return {THREE.AnimationClip}\n\t\t */\n\t\tbuildSkeletalAnimation: function ( vmd, mesh ) {\n\n\t\t\tfunction pushInterpolation( array, interpolation, index ) {\n\n\t\t\t\tarray.push( interpolation[ index + 0 ] / 127 ); // x1\n\t\t\t\tarray.push( interpolation[ index + 8 ] / 127 ); // x2\n\t\t\t\tarray.push( interpolation[ index + 4 ] / 127 ); // y1\n\t\t\t\tarray.push( interpolation[ index + 12 ] / 127 ); // y2\n\n\t\t\t}\n\n\t\t\tvar tracks = [];\n\n\t\t\tvar motions = {};\n\t\t\tvar bones = mesh.skeleton.bones;\n\t\t\tvar boneNameDictionary = {};\n\n\t\t\tfor ( var i = 0, il = bones.length; i < il; i ++ ) {\n\n\t\t\t\tboneNameDictionary[ bones[ i ].name ] = true;\n\n\t\t\t}\n\n\t\t\tfor ( var i = 0; i < vmd.metadata.motionCount; i ++ ) {\n\n\t\t\t\tvar motion = vmd.motions[ i ];\n\t\t\t\tvar boneName = motion.boneName;\n\n\t\t\t\tif ( boneNameDictionary[ boneName ] === undefined ) continue;\n\n\t\t\t\tmotions[ boneName ] = motions[ boneName ] || [];\n\t\t\t\tmotions[ boneName ].push( motion );\n\n\t\t\t}\n\n\t\t\tfor ( var key in motions ) {\n\n\t\t\t\tvar array = motions[ key ];\n\n\t\t\t\tarray.sort( function ( a, b ) {\n\n\t\t\t\t\treturn a.frameNum - b.frameNum;\n\n\t\t\t\t} );\n\n\t\t\t\tvar times = [];\n\t\t\t\tvar positions = [];\n\t\t\t\tvar rotations = [];\n\t\t\t\tvar pInterpolations = [];\n\t\t\t\tvar rInterpolations = [];\n\n\t\t\t\tvar basePosition = mesh.skeleton.getBoneByName( key ).position.toArray();\n\n\t\t\t\tfor ( var i = 0, il = array.length; i < il; i ++ ) {\n\n\t\t\t\t\tvar time = array[ i ].frameNum / 30;\n\t\t\t\t\tvar position = array[ i ].position;\n\t\t\t\t\tvar rotation = array[ i ].rotation;\n\t\t\t\t\tvar interpolation = array[ i ].interpolation;\n\n\t\t\t\t\ttimes.push( time );\n\n\t\t\t\t\tfor ( var j = 0; j < 3; j ++ ) positions.push( basePosition[ j ] + position[ j ] );\n\t\t\t\t\tfor ( var j = 0; j < 4; j ++ ) rotations.push( rotation[ j ] );\n\t\t\t\t\tfor ( var j = 0; j < 3; j ++ ) pushInterpolation( pInterpolations, interpolation, j );\n\n\t\t\t\t\tpushInterpolation( rInterpolations, interpolation, 3 );\n\n\t\t\t\t}\n\n\t\t\t\tvar targetName = '.bones[' + key + ']';\n\n\t\t\t\ttracks.push( this._createTrack( targetName + '.position', THREE.VectorKeyframeTrack, times, positions, pInterpolations ) );\n\t\t\t\ttracks.push( this._createTrack( targetName + '.quaternion', THREE.QuaternionKeyframeTrack, times, rotations, rInterpolations ) );\n\n\t\t\t}\n\n\t\t\treturn new THREE.AnimationClip( '', - 1, tracks );\n\n\t\t},\n\n\t\t/**\n\t\t * @param {Object} vmd - parsed VMD data\n\t\t * @param {THREE.SkinnedMesh} mesh - tracks will be fitting to mesh\n\t\t * @return {THREE.AnimationClip}\n\t\t */\n\t\tbuildMorphAnimation: function ( vmd, mesh ) {\n\n\t\t\tvar tracks = [];\n\n\t\t\tvar morphs = {};\n\t\t\tvar morphTargetDictionary = mesh.morphTargetDictionary;\n\n\t\t\tfor ( var i = 0; i < vmd.metadata.morphCount; i ++ ) {\n\n\t\t\t\tvar morph = vmd.morphs[ i ];\n\t\t\t\tvar morphName = morph.morphName;\n\n\t\t\t\tif ( morphTargetDictionary[ morphName ] === undefined ) continue;\n\n\t\t\t\tmorphs[ morphName ] = morphs[ morphName ] || [];\n\t\t\t\tmorphs[ morphName ].push( morph );\n\n\t\t\t}\n\n\t\t\tfor ( var key in morphs ) {\n\n\t\t\t\tvar array = morphs[ key ];\n\n\t\t\t\tarray.sort( function ( a, b ) {\n\n\t\t\t\t\treturn a.frameNum - b.frameNum;\n\n\t\t\t\t} );\n\n\t\t\t\tvar times = [];\n\t\t\t\tvar values = [];\n\n\t\t\t\tfor ( var i = 0, il = array.length; i < il; i ++ ) {\n\n\t\t\t\t\ttimes.push( array[ i ].frameNum / 30 );\n\t\t\t\t\tvalues.push( array[ i ].weight );\n\n\t\t\t\t}\n\n\t\t\t\ttracks.push( new THREE.NumberKeyframeTrack( '.morphTargetInfluences[' + morphTargetDictionary[ key ] + ']', times, values ) );\n\n\t\t\t}\n\n\t\t\treturn new THREE.AnimationClip( '', - 1, tracks );\n\n\t\t},\n\n\t\t/**\n\t\t * @param {Object} vmd - parsed VMD data\n\t\t * @return {THREE.AnimationClip}\n\t\t */\n\t\tbuildCameraAnimation: function ( vmd ) {\n\n\t\t\tfunction pushVector3( array, vec ) {\n\n\t\t\t\tarray.push( vec.x );\n\t\t\t\tarray.push( vec.y );\n\t\t\t\tarray.push( vec.z );\n\n\t\t\t}\n\n\t\t\tfunction pushQuaternion( array, q ) {\n\n\t\t\t\tarray.push( q.x );\n\t\t\t\tarray.push( q.y );\n\t\t\t\tarray.push( q.z );\n\t\t\t\tarray.push( q.w );\n\n\t\t\t}\n\n\t\t\tfunction pushInterpolation( array, interpolation, index ) {\n\n\t\t\t\tarray.push( interpolation[ index * 4 + 0 ] / 127 ); // x1\n\t\t\t\tarray.push( interpolation[ index * 4 + 1 ] / 127 ); // x2\n\t\t\t\tarray.push( interpolation[ index * 4 + 2 ] / 127 ); // y1\n\t\t\t\tarray.push( interpolation[ index * 4 + 3 ] / 127 ); // y2\n\n\t\t\t}\n\n\t\t\tvar tracks = [];\n\n\t\t\tvar cameras = vmd.cameras === undefined ? [] : vmd.cameras.slice();\n\n\t\t\tcameras.sort( function ( a, b ) {\n\n\t\t\t\treturn a.frameNum - b.frameNum;\n\n\t\t\t} );\n\n\t\t\tvar times = [];\n\t\t\tvar centers = [];\n\t\t\tvar quaternions = [];\n\t\t\tvar positions = [];\n\t\t\tvar fovs = [];\n\n\t\t\tvar cInterpolations = [];\n\t\t\tvar qInterpolations = [];\n\t\t\tvar pInterpolations = [];\n\t\t\tvar fInterpolations = [];\n\n\t\t\tvar quaternion = new THREE.Quaternion();\n\t\t\tvar euler = new THREE.Euler();\n\t\t\tvar position = new THREE.Vector3();\n\t\t\tvar center = new THREE.Vector3();\n\n\t\t\tfor ( var i = 0, il = cameras.length; i < il; i ++ ) {\n\n\t\t\t\tvar motion = cameras[ i ];\n\n\t\t\t\tvar time = motion.frameNum / 30;\n\t\t\t\tvar pos = motion.position;\n\t\t\t\tvar rot = motion.rotation;\n\t\t\t\tvar distance = motion.distance;\n\t\t\t\tvar fov = motion.fov;\n\t\t\t\tvar interpolation = motion.interpolation;\n\n\t\t\t\ttimes.push( time );\n\n\t\t\t\tposition.set( 0, 0, - distance );\n\t\t\t\tcenter.set( pos[ 0 ], pos[ 1 ], pos[ 2 ] );\n\n\t\t\t\teuler.set( - rot[ 0 ], - rot[ 1 ], - rot[ 2 ] );\n\t\t\t\tquaternion.setFromEuler( euler );\n\n\t\t\t\tposition.add( center );\n\t\t\t\tposition.applyQuaternion( quaternion );\n\n\t\t\t\tpushVector3( centers, center );\n\t\t\t\tpushQuaternion( quaternions, quaternion );\n\t\t\t\tpushVector3( positions, position );\n\n\t\t\t\tfovs.push( fov );\n\n\t\t\t\tfor ( var j = 0; j < 3; j ++ ) {\n\n\t\t\t\t\tpushInterpolation( cInterpolations, interpolation, j );\n\n\t\t\t\t}\n\n\t\t\t\tpushInterpolation( qInterpolations, interpolation, 3 );\n\n\t\t\t\t// use the same parameter for x, y, z axis.\n\t\t\t\tfor ( var j = 0; j < 3; j ++ ) {\n\n\t\t\t\t\tpushInterpolation( pInterpolations, interpolation, 4 );\n\n\t\t\t\t}\n\n\t\t\t\tpushInterpolation( fInterpolations, interpolation, 5 );\n\n\t\t\t}\n\n\t\t\tvar tracks = [];\n\n\t\t\t// I expect an object whose name 'target' exists under THREE.Camera\n\t\t\ttracks.push( this._createTrack( 'target.position', THREE.VectorKeyframeTrack, times, centers, cInterpolations ) );\n\n\t\t\ttracks.push( this._createTrack( '.quaternion', THREE.QuaternionKeyframeTrack, times, quaternions, qInterpolations ) );\n\t\t\ttracks.push( this._createTrack( '.position', THREE.VectorKeyframeTrack, times, positions, pInterpolations ) );\n\t\t\ttracks.push( this._createTrack( '.fov', THREE.NumberKeyframeTrack, times, fovs, fInterpolations ) );\n\n\t\t\treturn new THREE.AnimationClip( '', - 1, tracks );\n\n\t\t},\n\n\t\t// private method\n\n\t\t_createTrack: function ( node, typedKeyframeTrack, times, values, interpolations ) {\n\n\t\t\t/*\n\t\t\t * optimizes here not to let KeyframeTrackPrototype optimize\n\t\t\t * because KeyframeTrackPrototype optimizes times and values but\n\t\t\t * doesn't optimize interpolations.\n\t\t\t */\n\t\t\tif ( times.length > 2 ) {\n\n\t\t\t\ttimes = times.slice();\n\t\t\t\tvalues = values.slice();\n\t\t\t\tinterpolations = interpolations.slice();\n\n\t\t\t\tvar stride = values.length / times.length;\n\t\t\t\tvar interpolateStride = interpolations.length / times.length;\n\n\t\t\t\tvar index = 1;\n\n\t\t\t\tfor ( var aheadIndex = 2, endIndex = times.length; aheadIndex < endIndex; aheadIndex ++ ) {\n\n\t\t\t\t\tfor ( var i = 0; i < stride; i ++ ) {\n\n\t\t\t\t\t\tif ( values[ index * stride + i ] !== values[ ( index - 1 ) * stride + i ] ||\n\t\t\t\t\t\t\tvalues[ index * stride + i ] !== values[ aheadIndex * stride + i ] ) {\n\n\t\t\t\t\t\t\tindex ++;\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( aheadIndex > index ) {\n\n\t\t\t\t\t\ttimes[ index ] = times[ aheadIndex ];\n\n\t\t\t\t\t\tfor ( var i = 0; i < stride; i ++ ) {\n\n\t\t\t\t\t\t\tvalues[ index * stride + i ] = values[ aheadIndex * stride + i ];\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tfor ( var i = 0; i < interpolateStride; i ++ ) {\n\n\t\t\t\t\t\t\tinterpolations[ index * interpolateStride + i ] = interpolations[ aheadIndex * interpolateStride + i ];\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\ttimes.length = index + 1;\n\t\t\t\tvalues.length = ( index + 1 ) * stride;\n\t\t\t\tinterpolations.length = ( index + 1 ) * interpolateStride;\n\n\t\t\t}\n\n\t\t\tvar track = new typedKeyframeTrack( node, times, values );\n\n\t\t\ttrack.createInterpolant = function InterpolantFactoryMethodCubicBezier( result ) {\n\n\t\t\t\treturn new CubicBezierInterpolation( this.times, this.values, this.getValueSize(), result, new Float32Array( interpolations ) );\n\n\t\t\t};\n\n\t\t\treturn track;\n\n\t\t}\n\n\t};\n\n\t// interpolation\n\n\tfunction CubicBezierInterpolation( parameterPositions, sampleValues, sampleSize, resultBuffer, params ) {\n\n\t\tTHREE.Interpolant.call( this, parameterPositions, sampleValues, sampleSize, resultBuffer );\n\n\t\tthis.interpolationParams = params;\n\n\t}\n\n\tCubicBezierInterpolation.prototype = Object.assign( Object.create( THREE.Interpolant.prototype ), {\n\n\t\tconstructor: CubicBezierInterpolation,\n\n\t\tinterpolate_: function ( i1, t0, t, t1 ) {\n\n\t\t\tvar result = this.resultBuffer;\n\t\t\tvar values = this.sampleValues;\n\t\t\tvar stride = this.valueSize;\n\t\t\tvar params = this.interpolationParams;\n\n\t\t\tvar offset1 = i1 * stride;\n\t\t\tvar offset0 = offset1 - stride;\n\n\t\t\t// No interpolation if next key frame is in one frame in 30fps.\n\t\t\t// This is from MMD animation spec.\n\t\t\t// '1.5' is for precision loss. times are Float32 in Three.js Animation system.\n\t\t\tvar weight1 = ( ( t1 - t0 ) < 1 / 30 * 1.5 ) ? 0.0 : ( t - t0 ) / ( t1 - t0 );\n\n\t\t\tif ( stride === 4 ) { // Quaternion\n\n\t\t\t\tvar x1 = params[ i1 * 4 + 0 ];\n\t\t\t\tvar x2 = params[ i1 * 4 + 1 ];\n\t\t\t\tvar y1 = params[ i1 * 4 + 2 ];\n\t\t\t\tvar y2 = params[ i1 * 4 + 3 ];\n\n\t\t\t\tvar ratio = this._calculate( x1, x2, y1, y2, weight1 );\n\n\t\t\t\tTHREE.Quaternion.slerpFlat( result, 0, values, offset0, values, offset1, ratio );\n\n\t\t\t} else if ( stride === 3 ) { // Vector3\n\n\t\t\t\tfor ( var i = 0; i !== stride; ++ i ) {\n\n\t\t\t\t\tvar x1 = params[ i1 * 12 + i * 4 + 0 ];\n\t\t\t\t\tvar x2 = params[ i1 * 12 + i * 4 + 1 ];\n\t\t\t\t\tvar y1 = params[ i1 * 12 + i * 4 + 2 ];\n\t\t\t\t\tvar y2 = params[ i1 * 12 + i * 4 + 3 ];\n\n\t\t\t\t\tvar ratio = this._calculate( x1, x2, y1, y2, weight1 );\n\n\t\t\t\t\tresult[ i ] = values[ offset0 + i ] * ( 1 - ratio ) + values[ offset1 + i ] * ratio;\n\n\t\t\t\t}\n\n\t\t\t} else { // Number\n\n\t\t\t\tvar x1 = params[ i1 * 4 + 0 ];\n\t\t\t\tvar x2 = params[ i1 * 4 + 1 ];\n\t\t\t\tvar y1 = params[ i1 * 4 + 2 ];\n\t\t\t\tvar y2 = params[ i1 * 4 + 3 ];\n\n\t\t\t\tvar ratio = this._calculate( x1, x2, y1, y2, weight1 );\n\n\t\t\t\tresult[ 0 ] = values[ offset0 ] * ( 1 - ratio ) + values[ offset1 ] * ratio;\n\n\t\t\t}\n\n\t\t\treturn result;\n\n\t\t},\n\n\t\t_calculate: function ( x1, x2, y1, y2, x ) {\n\n\t\t\t/*\n\t\t\t * Cubic Bezier curves\n\t\t\t *   https://en.wikipedia.org/wiki/B%C3%A9zier_curve#Cubic_B.C3.A9zier_curves\n\t\t\t *\n\t\t\t * B(t) = ( 1 - t ) ^ 3 * P0\n\t\t\t *      + 3 * ( 1 - t ) ^ 2 * t * P1\n\t\t\t *      + 3 * ( 1 - t ) * t^2 * P2\n\t\t\t *      + t ^ 3 * P3\n\t\t\t *      ( 0 <= t <= 1 )\n\t\t\t *\n\t\t\t * MMD uses Cubic Bezier curves for bone and camera animation interpolation.\n\t\t\t *   http://d.hatena.ne.jp/edvakf/20111016/1318716097\n\t\t\t *\n\t\t\t *    x = ( 1 - t ) ^ 3 * x0\n\t\t\t *      + 3 * ( 1 - t ) ^ 2 * t * x1\n\t\t\t *      + 3 * ( 1 - t ) * t^2 * x2\n\t\t\t *      + t ^ 3 * x3\n\t\t\t *    y = ( 1 - t ) ^ 3 * y0\n\t\t\t *      + 3 * ( 1 - t ) ^ 2 * t * y1\n\t\t\t *      + 3 * ( 1 - t ) * t^2 * y2\n\t\t\t *      + t ^ 3 * y3\n\t\t\t *      ( x0 = 0, y0 = 0 )\n\t\t\t *      ( x3 = 1, y3 = 1 )\n\t\t\t *      ( 0 <= t, x1, x2, y1, y2 <= 1 )\n\t\t\t *\n\t\t\t * Here solves this equation with Bisection method,\n\t\t\t *   https://en.wikipedia.org/wiki/Bisection_method\n\t\t\t * gets t, and then calculate y.\n\t\t\t *\n\t\t\t * f(t) = 3 * ( 1 - t ) ^ 2 * t * x1\n\t\t\t *      + 3 * ( 1 - t ) * t^2 * x2\n\t\t\t *      + t ^ 3 - x = 0\n\t\t\t *\n\t\t\t * (Another option: Newton's method\n\t\t\t *    https://en.wikipedia.org/wiki/Newton%27s_method)\n\t\t\t */\n\n\t\t\tvar c = 0.5;\n\t\t\tvar t = c;\n\t\t\tvar s = 1.0 - t;\n\t\t\tvar loop = 15;\n\t\t\tvar eps = 1e-5;\n\t\t\tvar math = Math;\n\n\t\t\tvar sst3, stt3, ttt;\n\n\t\t\tfor ( var i = 0; i < loop; i ++ ) {\n\n\t\t\t\tsst3 = 3.0 * s * s * t;\n\t\t\t\tstt3 = 3.0 * s * t * t;\n\t\t\t\tttt = t * t * t;\n\n\t\t\t\tvar ft = ( sst3 * x1 ) + ( stt3 * x2 ) + ( ttt ) - x;\n\n\t\t\t\tif ( math.abs( ft ) < eps ) break;\n\n\t\t\t\tc /= 2.0;\n\n\t\t\t\tt += ( ft < 0 ) ? c : - c;\n\t\t\t\ts = 1.0 - t;\n\n\t\t\t}\n\n\t\t\treturn ( sst3 * y1 ) + ( stt3 * y2 ) + ttt;\n\n\t\t}\n\n\t} );\n\n\treturn MMDLoader;\n\n} )();\n"]}